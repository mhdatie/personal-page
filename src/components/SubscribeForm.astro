---
// SubscribeForm.astro - Email subscription form component
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<div class="subscribe-form-container">
	<h2>Subscribe to my blog!</h2>
	<p>Get notified when I publish new articles about software engineering and leadership.</p>

	<form id="subscribe-form">
		<div class="form-group">
			<label for="email" class="visually-hidden">Email address</label>
			<input
				type="email"
				id="email"
				name="email"
				placeholder="your@email.com"
				required
				aria-label="Email address"
			/>
			<button type="submit" id="subscribe-button">
				<span class="button-text">Subscribe</span>
				<span class="button-loading" style="display: none;">Subscribing...</span>
			</button>
		</div>

		<!-- Cloudflare Turnstile widget -->
		<div id="turnstile-widget"></div>

		<div id="form-message" class="form-message" role="alert" aria-live="polite"></div>
	</form>
</div>

<!-- Cloudflare Turnstile Script -->
<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>

<style>
	.subscribe-form-container {
		margin: 2rem 0;
		padding: 2rem;
		background: #f5f5f5;
		border-radius: 8px;
	}

	.subscribe-form-container h2 {
		margin-top: 0;
		font-size: 1.5rem;
	}

	.subscribe-form-container p {
		color: #666;
		margin-bottom: 1.5rem;
	}

	.form-group {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	#turnstile-widget {
		margin-top: 1rem;
	}

	input[type="email"] {
		flex: 1 1 0;
		min-width: 0;
		max-width: 100%;
		padding: 0.75rem 1rem;
		font-size: 1rem;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-family: inherit;
		box-sizing: border-box;
	}

	input[type="email"]:focus {
		outline: 2px solid #0066cc;
		outline-offset: 2px;
	}

	button {
		padding: 0.75rem 1.5rem;
		font-size: 1rem;
		background: #0066cc;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-family: inherit;
		font-weight: 500;
		transition: background 0.2s;
	}

	button:hover:not(:disabled) {
		background: #0052a3;
	}

	button:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	.form-message {
		margin-top: 1rem;
		padding: 0.75rem;
		border-radius: 4px;
		display: none;
	}

	.form-message.success {
		display: block;
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.form-message.error {
		display: block;
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}

	@media (max-width: 600px) {
		.form-group {
			flex-direction: column;
		}

		input[type="email"],
		button {
			width: 100%;
		}
	}
</style>

<script is:inline define:vars={{ TURNSTILE_SITE_KEY }}>
	// Store widget ID globally
	window.turnstileWidgetId = null;

	// Function to render Turnstile when ready
	function renderTurnstile() {
		if (window.turnstile && document.getElementById('turnstile-widget')) {
			window.turnstileWidgetId = window.turnstile.render('#turnstile-widget', {
				sitekey: TURNSTILE_SITE_KEY,
			});
		}
	}

	// Render Turnstile when script loads or page is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', function() {
			setTimeout(renderTurnstile, 100);
		});
	} else {
		setTimeout(renderTurnstile, 100);
	}
</script>

<script>
	const form = document.getElementById('subscribe-form') as HTMLFormElement;
	const emailInput = document.getElementById('email') as HTMLInputElement;
	const submitButton = document.getElementById('subscribe-button') as HTMLButtonElement;
	const buttonText = submitButton.querySelector('.button-text') as HTMLSpanElement;
	const buttonLoading = submitButton.querySelector('.button-loading') as HTMLSpanElement;
	const messageDiv = document.getElementById('form-message') as HTMLDivElement;

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		e.stopPropagation();

		const email = emailInput.value.trim();

		// Client-side validation
		if (!email) {
			showMessage('Please enter your email address.', 'error');
			return false;
		}

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailRegex.test(email)) {
			showMessage('Please enter a valid email address.', 'error');
			return false;
		}

		// Wait a bit for Turnstile to be ready if needed
		await new Promise(resolve => setTimeout(resolve, 100));

		// Get Turnstile token directly from the widget
		let turnstileToken = '';

		if ((window as any).turnstile && (window as any).turnstileWidgetId !== null && (window as any).turnstileWidgetId !== undefined) {
			turnstileToken = (window as any).turnstile.getResponse((window as any).turnstileWidgetId);
		}

		console.log('Turnstile token:', turnstileToken ? 'Token received' : 'No token');

		// Check Turnstile completion
		if (!turnstileToken) {
			showMessage('Please complete the verification challenge.', 'error');
			return false;
		}

		// Set loading state
		submitButton.disabled = true;
		buttonText.style.display = 'none';
		buttonLoading.style.display = 'inline';
		messageDiv.style.display = 'none';

		try {
			const response = await fetch('/api/subscribe', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					email,
					turnstileToken
				}),
			});

			const data = await response.json();

			if (response.ok) {
				showMessage(data.message || 'Successfully subscribed!', 'success');
				emailInput.value = '';
				// Reset Turnstile widget on success
				if ((window as any).turnstile && (window as any).turnstileWidgetId !== null) {
					(window as any).turnstile.reset((window as any).turnstileWidgetId);
				}
			} else {
				showMessage(data.error || 'Something went wrong. Please try again.', 'error');
				// Reset Turnstile on error too, so user can try again
				if ((window as any).turnstile && (window as any).turnstileWidgetId !== null) {
					(window as any).turnstile.reset((window as any).turnstileWidgetId);
				}
			}
		} catch (error) {
			console.error('Subscription error:', error);
			showMessage('Network error. Please check your connection and try again.', 'error');
			// Reset Turnstile on error
			if ((window as any).turnstile && (window as any).turnstileWidgetId !== null) {
				(window as any).turnstile.reset((window as any).turnstileWidgetId);
			}
		} finally {
			// Reset button state
			submitButton.disabled = false;
			buttonText.style.display = 'inline';
			buttonLoading.style.display = 'none';
		}

		return false;
	});

	function showMessage(message: string, type: 'success' | 'error') {
		messageDiv.textContent = message;
		messageDiv.className = `form-message ${type}`;
		messageDiv.style.display = 'block';
	}
</script>
