---
// SubscribeForm.astro - Email subscription form component
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<div class="subscribe-form-container">
	<h2>Subscribe to my blog!</h2>
	<p>Get notified when I publish new articles about software engineering and leadership.</p>

	<form id="subscribe-form">
		<div class="form-group">
			<label for="email" class="visually-hidden">Email address</label>
			<input
				type="email"
				id="email"
				name="email"
				placeholder="your@email.com"
				required
				aria-label="Email address"
			/>
			<button type="submit" id="subscribe-button">
				<span class="button-text">Subscribe</span>
				<span class="button-loading" style="display: none;">Subscribing...</span>
			</button>
		</div>

		<!-- Cloudflare Turnstile widget (created dynamically on-demand) -->
		<div id="turnstile-container"></div>

		<div id="form-message" class="form-message" role="alert" aria-live="polite"></div>
	</form>
</div>

<style>
	.subscribe-form-container {
		margin: 2rem 0;
		padding: 2rem;
		background: #f5f5f5;
		border-radius: 8px;
	}

	.subscribe-form-container h2 {
		margin-top: 0;
		font-size: 1.5rem;
	}

	.subscribe-form-container p {
		color: #666;
		margin-bottom: 1.5rem;
	}

	.form-group {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	#turnstile-container {
		margin-top: 1rem;
	}

	input[type="email"] {
		flex: 1 1 0;
		min-width: 0;
		max-width: 100%;
		padding: 0.75rem 1rem;
		font-size: 1rem;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-family: inherit;
		box-sizing: border-box;
	}

	input[type="email"]:focus {
		outline: 2px solid #0066cc;
		outline-offset: 2px;
	}

	button {
		padding: 0.75rem 1.5rem;
		font-size: 1rem;
		background: #0066cc;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-family: inherit;
		font-weight: 500;
		transition: background 0.2s;
	}

	button:hover:not(:disabled) {
		background: #0052a3;
	}

	button:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	.form-message {
		margin-top: 1rem;
		padding: 0.75rem;
		border-radius: 4px;
		display: none;
	}

	.form-message.success {
		display: block;
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.form-message.error {
		display: block;
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}

	@media (max-width: 600px) {
		.form-group {
			flex-direction: column;
		}

		input[type="email"],
		button {
			width: 100%;
		}
	}
</style>

<script is:inline define:vars={{ TURNSTILE_SITE_KEY }}>
	// Track Turnstile loading state
	window.turnstileLoaded = false;
	window.turnstileWidgetId = null;
	window.TURNSTILE_SITE_KEY = TURNSTILE_SITE_KEY;

	// Load Turnstile script dynamically
	window.loadTurnstile = function() {
		return new Promise((resolve, reject) => {
			// If already loaded, resolve immediately
			if (window.turnstile) {
				resolve();
				return;
			}

			// If script is loading, wait for it
			if (window.turnstileLoaded) {
				const checkInterval = setInterval(() => {
					if (window.turnstile) {
						clearInterval(checkInterval);
						resolve();
					}
				}, 100);
				return;
			}

			window.turnstileLoaded = true;

			const script = document.createElement('script');
			script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
			script.async = true;
			script.defer = true;
			script.onload = () => {
				// Wait a bit for Turnstile to initialize
				setTimeout(resolve, 200);
			};
			script.onerror = reject;
			document.head.appendChild(script);
		});
	};

	// Render Turnstile widget
	window.renderTurnstileWidget = function() {
		return new Promise((resolve) => {
			const container = document.getElementById('turnstile-container');

			// Clear any existing widget
			if (container) {
				container.innerHTML = '<div id="turnstile-widget"></div>';
			}

			// Render widget
			if (window.turnstile) {
				window.turnstileWidgetId = window.turnstile.render('#turnstile-widget', {
					sitekey: window.TURNSTILE_SITE_KEY,
					callback: function(token) {
						resolve(token);
					},
				});
			}
		});
	};
</script>

<script>
	const form = document.getElementById('subscribe-form') as HTMLFormElement;
	const emailInput = document.getElementById('email') as HTMLInputElement;
	const submitButton = document.getElementById('subscribe-button') as HTMLButtonElement;
	const buttonText = submitButton.querySelector('.button-text') as HTMLSpanElement;
	const buttonLoading = submitButton.querySelector('.button-loading') as HTMLSpanElement;
	const messageDiv = document.getElementById('form-message') as HTMLDivElement;

	let isSubmitting = false;

	// Utility: Set submitting state
	function setSubmitting(submitting: boolean) {
		isSubmitting = submitting;
		submitButton.disabled = submitting;
		buttonText.style.display = submitting ? 'none' : 'inline';
		buttonLoading.style.display = submitting ? 'inline' : 'none';

		if (submitting) {
			messageDiv.style.display = 'none';
		}
	}

	// Utility: Clear Turnstile widget
	function resetTurnstile() {
		const container = document.getElementById('turnstile-container');
		if (container) {
			container.innerHTML = '';
		}
	}

	// Utility: Show message
	function showMessage(message: string, type: 'success' | 'error') {
		messageDiv.textContent = message;
		messageDiv.className = `form-message ${type}`;
		messageDiv.style.display = 'block';
	}

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		e.stopPropagation();

		// Prevent double submission
		if (isSubmitting) return false;

		const email = emailInput.value.trim();

		// Client-side validation
		if (!email) {
			showMessage('Please enter your email address.', 'error');
			return false;
		}

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailRegex.test(email)) {
			showMessage('Please enter a valid email address.', 'error');
			return false;
		}

		setSubmitting(true);

		try {
			// Load Turnstile script if not loaded
			await (window as any).loadTurnstile();

			// Render widget and wait for verification
			const turnstileToken = await (window as any).renderTurnstileWidget();

			if (!turnstileToken) {
				showMessage('Verification failed. Please try again.', 'error');
				setSubmitting(false);
				return false;
			}

			// Submit to API
			const response = await fetch('/api/subscribe', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					email,
					turnstileToken
				}),
			});

			const data = await response.json();

			if (response.ok) {
				showMessage(data.message || 'Successfully subscribed!', 'success');
				emailInput.value = '';
				resetTurnstile();
			} else {
				showMessage(data.error || 'Something went wrong. Please try again.', 'error');
				resetTurnstile();
			}
		} catch (error) {
			console.error('Subscription error:', error);
			showMessage('An error occurred. Please try again.', 'error');
			resetTurnstile();
		} finally {
			setSubmitting(false);
		}

		return false;
	});
</script>
